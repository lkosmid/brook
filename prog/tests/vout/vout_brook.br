#include <stdio.h>
#include "streamholder.h"
float CountValuesfloat(struct StreamHolder list_stream,
                       struct StreamHolder output_stream,
                       int WIDTH, 
                       int LENGTH, 
                       int sign);

kernel void foo (float a<>, float b<>, float4 c,
		 float d[10][10], vout []float e<>) {
  e = a+b+d[c.xy];
  push(e);
  if (fmod( (indexof a).x,2)<.5) {
    e = 2;
    push (e);
  }
  if (fmod((indexof a).y,3)<.5) {
     e=1;
     push (e);
     e=-1;
     push (e);
  }
}

int main () {

  float a<10, 10>;
  float b<10, 10>;
  float d<10, 10>;
  float e<10, 10>;
  float nil<40,10>;
  float test <40,10>;
  float data_a[10][10];
  float data_b[10][10];
  float4 c = float4(1.0f, 0.0f, 3.2f, 5.0f);
  float data_d[10][10];
  float *data_nil;
  float d_broken = 0.0f;
  float *data_out;
  int i,j;
  data_out=(float*)malloc(10*40*sizeof(float));
  data_nil=(float*)malloc(10*40*sizeof(float));
  memset(data_nil,0,10*40*sizeof(float));
  for (i=0; i<10; i++)
    for (j=0; j<10; j++) {
      data_a[i][j] = ((float) i) + ((float) j) / 10.0f;
      data_b[i][j] = ((float) j) + ((float) i) / 10.0f;
      data_d[i][j] = ((float) i) / 100.0f;
    }
  
  streamRead(a, data_a);
  streamRead(b, data_b);
  streamRead(d, data_d);

  foo(a,b,c,d,e);
  //foo(a,b,c,d_broken,e);

  streamPrint(e);
  for (i=0;i<40;++i) {
     for (j=0;j<10;++j) {
       int k;
        data_nil[i*10+j]=1.0;
        streamRead(nil,data_nil);
        CountValuesfloat(&nil,&test,40,10,-1);
        streamWrite(test,data_out);
        data_nil[i*10+j]=0.0;

        for (k=0;k<10*40;++k) {
          if (k<i*10+j) {
            if (data_out[k]!=0) {
              printf ("Test %d %d not zero at %d %d\n",i,j,k/10,k%10);
              break;            
            }
          }else{
            if (data_out[k]!=1) {
              printf ("Test %d %d not one at %d %d\n",i,j,k/10,k%10);
              break;
              
            }
          }
                      
        }
     }
  }
  return 0;
}
